import { PDFDocument } from "@peculiarventures/pdf-doc";
import { PDFRepairRegistry, IRepairRule, globalRepairRegistry } from "./PDFRepairRegistry";
import { PDFRepairStatus } from "./PDFRepairStatus";

/**
 * An object that records repair notes for a PDF file. The keys are rule IDs and the values are arrays of strings
 * containing the repair notes.
 */
export interface RepairNotes {
  [key: string]: string[];
}

export interface RepairCheckRule {
  status: PDFRepairStatus;
  description: string;
}

export interface RepairCheck {
  status: PDFRepairStatus;
  rules: Record<string, RepairCheckRule>;
}

/**
 * A class for repairing PDF documents by applying a set of rules to them.
 */
export class PDFRepair {
  private rules: IRepairRule[] = [];

  constructor(registry: PDFRepairRegistry = globalRepairRegistry, ruleIds?: string[]) {
    this.rules = registry.getRules(ruleIds);
  }

  /**
   * Repairs a PDF document by applying a set of rules to it.
   * @param doc - The PDF document to repair.
   * @returns An array of strings representing the repair notes generated by the applied rules.
   */
  async repairDocument(doc: PDFDocument): Promise<RepairNotes> {
    const repairNotes: RepairNotes = {};

    for (const rule of this.rules) {
      const notes = await rule.apply(doc);
      if (notes.length) {
        if (repairNotes[rule.id]) {
          throw new Error(`Rule '${rule.id}' returned multiple repair notes.`);
        }
        repairNotes[rule.id] = notes;
      }
    }

    return repairNotes;
  }

  /**
   * Checks if a PDF document needs to be repaired.
   * @param doc - The PDF document to check.
   * @returns
   */
  async checkDocument(doc: PDFDocument): Promise<RepairCheck> {
    const check: RepairCheck = {
      status: PDFRepairStatus.notNeeded,
      rules: {},
    };

    for (const rule of this.rules) {
      const status = await rule.check(doc);
      if (check.status !== PDFRepairStatus.requireClone && status !== PDFRepairStatus.notNeeded) {
        check.status = status;
      }
      check.rules[rule.id] = {
        status,
        description: rule.description,
      };
    }

    return check;
  }
}
